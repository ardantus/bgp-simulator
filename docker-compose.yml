services:
  isp1:
    build:
      context: .
      dockerfile: Dockerfile.bird
    container_name: isp1
    hostname: isp1
    networks:
      isp1_network:
        ipv4_address: 10.1.1.254
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./configs/isp1/bird.conf:/etc/bird/bird.conf:ro
    command: >
      bash -c "
        apt-get update -qq && apt-get install -y iproute2 iptables iputils-ping -qq || true && \
        sysctl -w net.ipv4.ip_forward=1 || true && \
        iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE || true && \
        exec bird -f -c /etc/bird/bird.conf -d
      "
    restart: unless-stopped

  isp2:
    build:
      context: .
      dockerfile: Dockerfile.bird
    container_name: isp2
    hostname: isp2
    networks:
      isp2_network:
        ipv4_address: 10.2.2.254
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./configs/isp2/bird.conf:/etc/bird/bird.conf:ro
    command: >
      bash -c "
        apt-get update -qq && apt-get install -y iproute2 iptables iputils-ping -qq || true && \
        sysctl -w net.ipv4.ip_forward=1 || true && \
        iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE || true && \
        exec bird -f -c /etc/bird/bird.conf -d
      "
    restart: unless-stopped

  bgp-router:
    build:
      context: .
      dockerfile: Dockerfile.bird
    container_name: bgp-router
    hostname: bgp-router
    networks:
      isp1_network:
        ipv4_address: 10.1.1.2
      isp2_network:
        ipv4_address: 10.2.2.2
      internal_network:
        ipv4_address: 192.168.100.10
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./configs/bgp-router/bird.conf:/etc/bird/bird.conf:ro
    command: bird -f -c /etc/bird/bird.conf -d
    depends_on:
      - isp1
      - isp2
    restart: unless-stopped

  pfrouter:
    image: ubuntu:22.04
    container_name: pfrouter
    hostname: pfrouter
    networks:
      internal_network:
        ipv4_address: 192.168.100.2
      client_network:
        ipv4_address: 192.168.200.254
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./configs/pfrouter/routing.sh:/routing.sh:ro
    command: >
      bash -c "
        apt-get update && \
        apt-get install -y iproute2 iputils-ping tcpdump traceroute iptables net-tools && \
        chmod +x /routing.sh 2>/dev/null || true && \
        /routing.sh && \
        tail -f /dev/null
      "
    depends_on:
      - bgp-router
    restart: unless-stopped

  # egress1/egress2 removed â€” restored original topology

  client:
    build:
      context: .
      dockerfile: Dockerfile.client
    container_name: client
    hostname: client
    networks:
      client_network:
        ipv4_address: 192.168.200.10
    cap_add:
      - NET_ADMIN
      - NET_RAW
    depends_on:
      - pfrouter
    restart: unless-stopped

  # internet1/internet2 removed

networks:
  isp1_network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.1.1.0/24

  isp2_network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.2.2.0/24

  internal_network:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.100.0/24

  client_network:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.200.0/24

  # egress_net, internet1_net, internet2_net removed
