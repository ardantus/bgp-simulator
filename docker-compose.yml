services:
  # ISP1 - Simulated upstream provider 1
  isp1:
    build:
      context: .
      dockerfile: Dockerfile.bird
    container_name: isp1
    hostname: isp1
    networks:
      isp1_network:
        ipv4_address: 10.1.1.254
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./configs/isp1/bird.conf:/etc/bird/bird.conf:ro
    command: bird -f -c /etc/bird/bird.conf -d
    restart: unless-stopped

  # ISP2 - Simulated upstream provider 2
  isp2:
    build:
      context: .
      dockerfile: Dockerfile.bird
    container_name: isp2
    hostname: isp2
    networks:
      isp2_network:
        ipv4_address: 10.2.2.254
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./configs/isp2/bird.conf:/etc/bird/bird.conf:ro
    command: bird -f -c /etc/bird/bird.conf -d
    restart: unless-stopped

  # BGP Router - Main router connecting to both ISPs
  bgp-router:
    build:
      context: .
      dockerfile: Dockerfile.bird
    container_name: bgp-router
    hostname: bgp-router
    networks:
      isp1_network:
        ipv4_address: 10.1.1.2
      isp2_network:
        ipv4_address: 10.2.2.2
      internal_network:
        ipv4_address: 192.168.100.10
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./configs/bgp-router/bird.conf:/etc/bird/bird.conf:ro
    command: bird -f -c /etc/bird/bird.conf -d
    depends_on:
      - isp1
      - isp2
    restart: unless-stopped

  # pfRouter - Linux router for packet forwarding
  pfrouter:
    image: ubuntu:22.04
    container_name: pfrouter
    hostname: pfrouter
    networks:
      internal_network:
        ipv4_address: 192.168.100.2
      client_network:
        ipv4_address: 192.168.200.254
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./configs/pfrouter/routing.sh:/routing.sh:ro
    command: >
      bash -c "
        apt-get update && 
        apt-get install -y iproute2 iputils-ping tcpdump traceroute iptables net-tools &&
        chmod +x /routing.sh 2>/dev/null || true &&
        /routing.sh &&
        tail -f /dev/null
      "
    depends_on:
      - bgp-router
    restart: unless-stopped

  # Ubuntu Client - Test client with networking tools
  client:
    image: ubuntu:22.04
    container_name: client
    hostname: client
    networks:
      client_network:
        ipv4_address: 192.168.200.10
    cap_add:
      - NET_ADMIN
      - NET_RAW
    command: >
      bash -c "
        apt-get update && 
        apt-get install -y iproute2 iputils-ping tcpdump traceroute curl wget net-tools dnsutils &&
        ip route del default || true &&
        ip route add default via 192.168.200.254 &&
        tail -f /dev/null
      "
    depends_on:
      - pfrouter
    restart: unless-stopped

networks:
  isp1_network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.1.1.0/24
  
  isp2_network:
    driver: bridge
    ipam:
      config:
        - subnet: 10.2.2.0/24
  
  internal_network:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.100.0/24
  
  client_network:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.200.0/24
